#include "iqaxmm/CVlcVideoViewGuiComp.h"


// Qt includes
#include <QtCore/QtGLobal>
#include <QtCore/QUrl>
#if QT_VERSION < 0x050000
#include <QtGui/QVBoxLayout>
#else
#include <QtWidgets/QVBoxLayout>
#endif

// ACF includes
#include "istd/CChangeNotifier.h"
#include "istd/CGeneralTimeStamp.h"


namespace iqaxmm
{


// public methods

CVlcVideoViewGuiComp::CVlcVideoViewGuiComp()
:	m_vlcWidgetPtr(NULL),
	m_vlcInputPtr(NULL),
	m_playlistPtr(NULL)
{
}

// reimplemented (iqtgui::CGuiComponentBase)

void CVlcVideoViewGuiComp::OnGuiCreated()
{
	BaseClass::OnGuiCreated();

	QFrame* widgetPtr = GetQtWidget();
	if (widgetPtr != NULL){
		widgetPtr->setFrameStyle(QFrame::NoFrame);
		QVBoxLayout* layoutPtr = new QVBoxLayout(widgetPtr);
		layoutPtr->setContentsMargins(0, 0, 0, 0);
		widgetPtr->setLayout(layoutPtr);
	}
}


void CVlcVideoViewGuiComp::OnGuiDestroyed()
{
	if (m_vlcWidgetPtr != NULL){
		delete m_vlcWidgetPtr;
		m_vlcWidgetPtr = NULL;
		m_vlcInputPtr = NULL;
		m_playlistPtr = NULL;
	}

	m_currentUrl.clear();

	BaseClass::OnGuiDestroyed();
}


// reimplemented (imm::IMediaController)

QString CVlcVideoViewGuiComp::GetOpenedMediumUrl() const
{
	return m_currentUrl;
}


bool CVlcVideoViewGuiComp::OpenMediumUrl(const QString& url, bool autoPlay)
{
	if (m_vlcWidgetPtr != NULL){
		delete m_vlcWidgetPtr;
		m_vlcWidgetPtr = NULL;
		m_vlcInputPtr = NULL;
		m_playlistPtr = NULL;
	}

	QWidget* widgetPtr = GetQtWidget();
	if (widgetPtr != NULL){
		m_vlcWidgetPtr = new AXVLC::VLCPlugin2(widgetPtr);

		QLayout* layoutPtr = widgetPtr->layout();
		if (layoutPtr != NULL){
			layoutPtr->addWidget(m_vlcWidgetPtr);
		}

		static ChangeSet changeSet(CF_STATUS, CF_MEDIA_POSITION);
		istd::CChangeNotifier notifier(this, changeSet);

		m_vlcInputPtr = m_vlcWidgetPtr->input();

		m_playlistPtr = m_vlcWidgetPtr->playlist();
		if (m_playlistPtr != NULL){
			m_currentUrl = url;

			m_playlistPtr->clear();
			m_playlistPtr->add(m_currentUrl);
			m_playlistPtr->play();

			istd::CGeneralTimeStamp timer;
			timer.WaitTo(2);
			if (!autoPlay){
				m_playlistPtr->togglePause();
			}

			return true;
		}
	}

	return false;
}


void CVlcVideoViewGuiComp::CloseMedium()
{
	if (m_playlistPtr != NULL){
		static ChangeSet changeSet(CF_STATUS);
		istd::CChangeNotifier notifier(this, changeSet);

		m_playlistPtr->stop();
		m_playlistPtr->clear();
	}
}


bool CVlcVideoViewGuiComp::IsPlaying() const
{
	if (m_playlistPtr != NULL){
		return m_playlistPtr->isPlaying();
	}

	return false;
}


bool CVlcVideoViewGuiComp::SetPlaying(bool state)
{
	if (state != IsPlaying()){
		static ChangeSet changeSet(CF_STATUS);
		istd::CChangeNotifier notifier(this, changeSet);

		if (m_playlistPtr != NULL){
			m_playlistPtr->togglePause();

			return true;
		}
	}

	return false;
}


double CVlcVideoViewGuiComp::GetMediumLength() const
{
	if (m_vlcInputPtr != NULL){
		return m_vlcInputPtr->Length() * 0.001;
	}

	return 0;
}


double CVlcVideoViewGuiComp::GetCurrentPosition() const
{
	if (m_vlcInputPtr != NULL){
		return m_vlcInputPtr->Time() * 0.001;
	}

	return 0;
}


bool CVlcVideoViewGuiComp::SetCurrentPosition(double position)
{
	if (m_vlcInputPtr != NULL){
		static ChangeSet changeSet(CF_MEDIA_POSITION);
		istd::CChangeNotifier notifier(this, changeSet);

		m_vlcInputPtr->SetTime(int(position * 1000));

		return true;
	}

	return false;
}


int	CVlcVideoViewGuiComp::GetSupportedFeatures() const
{
	return SF_OPEN_MEDIA | SF_PLAY | SF_AUTO_PLAY | SF_SEEK;
}


// reimplemented (imm::IVideoInfo)

int CVlcVideoViewGuiComp::GetFramesCount() const
{
	return int(GetMediumLength() * *m_framesPerSecondAttrPtr);
}


double CVlcVideoViewGuiComp::GetFrameIntervall() const
{
	return 1.0 / *m_framesPerSecondAttrPtr;
}


istd::CIndex2d CVlcVideoViewGuiComp::GetFrameSize() const
{
	return istd::CIndex2d::GetInvalid();
}


double CVlcVideoViewGuiComp::GetPixelAspectRatio() const
{
	return -1;
}


// reimplemented (imm::IVideoController)

int CVlcVideoViewGuiComp::GetCurrentFrame() const
{
	return int(GetCurrentPosition() * *m_framesPerSecondAttrPtr + 0.5);
}


bool CVlcVideoViewGuiComp::SetCurrentFrame(int frameIndex)
{
	return SetCurrentPosition(frameIndex / *m_framesPerSecondAttrPtr);
}


// reimplemented (ifile::IFileTypeInfo)

bool CVlcVideoViewGuiComp::GetFileExtensions(QStringList& result, int flags, bool doAppend) const
{
	if (!doAppend){
		result.clear();
	}

	if ((flags & QF_SAVE) != 0){
		result.push_back("mpg");
		result.push_back("avi");
	}

	return true;
}


QString CVlcVideoViewGuiComp::GetTypeDescription(const QString* /*extensionPtr*/) const
{
	return "Video files";
}


} // namespace iqaxmm


